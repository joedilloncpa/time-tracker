generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  super_admin
  firm_admin
  firm_user
}

enum ClientStatus {
  active
  inactive
  prospect
}

enum WorkstreamStatus {
  active
  paused
  complete
  archived
}

enum BillingType {
  hourly
  fixed
  retainer
}

enum EmploymentType {
  full_time
  part_time
  contractor
}

enum TimesheetStatus {
  draft
  submitted
  approved
  rejected
}

model Tenant {
  id                     String         @id @default(cuid())
  name                   String
  slug                   String         @unique
  logoUrl                String?
  timezone               String         @default("America/New_York")
  fiscalYearStart        Int            @default(1)
  settingsJson           Json?
  stripeCustomerId       String?        @unique
  stripeSubscriptionId   String?        @unique
  subscriptionStatus     String         @default("trialing")
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  users                  User[]
  clients                Client[]
  workstreams            Workstream[]
  timeEntries            TimeEntry[]
  timerSessions          TimerSession[]
  lockedPeriods          LockedPeriod[]
  timesheetApprovals     TimesheetApproval[]
  auditLogs              AuditLog[]
}

model User {
  id                 String          @id @default(cuid())
  tenantId           String?
  supabaseAuthId     String?         @unique
  email              String          @unique
  name               String
  avatarUrl          String?
  timezone           String?
  role               UserRole        @default(firm_user)
  costRate           Decimal?        @db.Decimal(10, 2)
  defaultBillingRate Decimal?        @db.Decimal(10, 2)
  startDate          DateTime?
  employmentType     EmploymentType?
  isActive           Boolean         @default(true)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  tenant             Tenant?         @relation(fields: [tenantId], references: [id])
  timeEntries        TimeEntry[]
  timerSessions      TimerSession[]
  lockedByPeriods    LockedPeriod[]  @relation("lockedByUser")
  unlockedByPeriods  LockedPeriod[]  @relation("unlockedByUser")
  submittedTimesheets TimesheetApproval[] @relation("timesheetOwner")
  reviewedTimesheets TimesheetApproval[]  @relation("timesheetReviewer")
  auditLogs          AuditLog[]

  @@index([tenantId])
  @@index([tenantId, role])
}

model Client {
  id                 String        @id @default(cuid())
  tenantId           String
  name               String
  code               String?
  contactName        String?
  contactEmail       String?
  phone              String?
  industry           String?
  status             ClientStatus  @default(active)
  notes              String?
  tags               String[]
  defaultBillingRate Decimal?      @db.Decimal(10, 2)
  budgetHours        Decimal?      @db.Decimal(10, 2)
  budgetAmount       Decimal?      @db.Decimal(12, 2)
  qboXeroLink        String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  tenant             Tenant        @relation(fields: [tenantId], references: [id])
  workstreams        Workstream[]
  timeEntries        TimeEntry[]

  @@index([tenantId])
  @@index([tenantId, status])
}

model Workstream {
  id                String           @id @default(cuid())
  tenantId          String
  clientId          String
  name              String
  serviceType       String?
  description       String?
  billingType       BillingType      @default(hourly)
  billingRate       Decimal?         @db.Decimal(10, 2)
  fixedFeeAmount    Decimal?         @db.Decimal(12, 2)
  retainerAmount    Decimal?         @db.Decimal(12, 2)
  retainerFrequency String?
  estimatedHours    Decimal?         @db.Decimal(10, 2)
  startDate         DateTime?
  endDate           DateTime?
  status            WorkstreamStatus @default(active)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  tenant            Tenant           @relation(fields: [tenantId], references: [id])
  client            Client           @relation(fields: [clientId], references: [id])
  timeEntries       TimeEntry[]

  @@index([tenantId])
  @@index([clientId])
}

model TimeEntry {
  id              String    @id @default(cuid())
  tenantId        String
  userId          String
  clientId        String
  workstreamId    String
  date            DateTime
  startTime       DateTime?
  endTime         DateTime?
  durationMinutes Int
  isBillable      Boolean   @default(true)
  notes           String?   @db.VarChar(500)
  tags            String[]
  isInvoiced      Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  user            User      @relation(fields: [userId], references: [id])
  client          Client    @relation(fields: [clientId], references: [id])
  workstream      Workstream @relation(fields: [workstreamId], references: [id])

  @@index([tenantId, date])
  @@index([tenantId, userId, date])
}

model TimerSession {
  id           String   @id @default(cuid())
  tenantId     String
  userId       String
  startedAt    DateTime
  clientId     String?
  workstreamId String?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  user         User     @relation(fields: [userId], references: [id])

  @@unique([userId])
  @@index([tenantId])
}

model LockedPeriod {
  id               String    @id @default(cuid())
  tenantId         String
  periodYear       Int
  periodMonth      Int
  lockedAt         DateTime  @default(now())
  lockedByUserId   String
  unlockedAt       DateTime?
  unlockedByUserId String?
  tenant           Tenant    @relation(fields: [tenantId], references: [id])
  lockedByUser     User      @relation("lockedByUser", fields: [lockedByUserId], references: [id])
  unlockedByUser   User?     @relation("unlockedByUser", fields: [unlockedByUserId], references: [id])

  @@unique([tenantId, periodYear, periodMonth])
  @@index([tenantId, periodYear, periodMonth])
}

model TimesheetApproval {
  id            String         @id @default(cuid())
  tenantId      String
  userId        String
  weekStartDate DateTime
  status        TimesheetStatus @default(draft)
  submittedAt   DateTime?
  reviewedAt    DateTime?
  reviewerId    String?
  reviewerNotes String?
  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  user          User           @relation("timesheetOwner", fields: [userId], references: [id])
  reviewer      User?          @relation("timesheetReviewer", fields: [reviewerId], references: [id])

  @@unique([tenantId, userId, weekStartDate])
  @@index([tenantId, status])
}

model AuditLog {
  id         String   @id @default(cuid())
  tenantId   String
  userId     String?
  action     String
  entityType String
  entityId   String
  oldValue   Json?
  newValue   Json?
  createdAt  DateTime @default(now())
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  user       User?    @relation(fields: [userId], references: [id])

  @@index([tenantId, createdAt])
  @@index([tenantId, entityType, entityId])
}
